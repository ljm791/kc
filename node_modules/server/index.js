require("dotenv").config();
const express = require("express");
const http = require("http");
const cors = require("cors");
const { Server } = require("socket.io");
const connectDB = require("./src/db");
const setupSocket = require("./src/socket");
const Channel = require("./src/model/channel");
const Message = require("./src/model/message");

const app = express();
const server = http.createServer(app);
const io = new Server(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"],
  },
});

// ë¯¸ë“¤ì›¨ì–´
app.use(cors());
app.use(express.json());

// ë¼ìš°í„°
app.get("/", (req, res) => {
  res.send("Server is running!");
});

app.get("/channels", async (req, res) => {
  const channels = await Channel.find({});
  res.json(channels);
});

app.post("/channels", async (req, res) => {
  const { name } = req.body;
  if (!name || name.trim() === "") {
    return res.status(400).json({ error: "ì±„ë„ ì´ë¦„ì€ í•„ìˆ˜ìž…ë‹ˆë‹¤." });
  }

  const existing = await Channel.findOne({ name });
  if (existing) {
    return res.status(409).json({ error: "ì´ë¯¸ ì¡´ìž¬í•˜ëŠ” ì±„ë„ìž…ë‹ˆë‹¤." });
  }

  const newChannel = new Channel({ name });
  await newChannel.save();
  res.status(201).json(newChannel);
});

// ì±„ë„ë³„ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
app.get("/messages/:channelId", async (req, res) => {
  const { channelId } = req.params;

  try {
    const messages = await Message.find({ channelId })
      .sort({ createdAt: 1 }); // ì˜¤ëž˜ëœ ìˆœìœ¼ë¡œ ì •ë ¬
    res.json(messages);
  } catch (err) {
    console.error("âŒ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    res.status(500).json({ error: "ì„œë²„ ì—ëŸ¬" });
  }
});

// DB ì—°ê²°
connectDB();

// ì†Œì¼“ ì„¤ì •
setupSocket(io);

// ì„œë²„ ì‹œìž‘
const PORT = process.env.PORT || 4000;
server.listen(PORT, () => {
  console.log(`ðŸš€ Server listening on http://localhost:${PORT}`);
});
